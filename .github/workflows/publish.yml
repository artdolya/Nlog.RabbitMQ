name: Release to Nuget
on:
  release:
    types: [published]

jobs:
  build:
    name: Create Nuget Package
    runs-on: windows-2019

    steps:
      - name: Get Release Notes
        uses: actions/github-script@v6
        id: release-notes
        env:
          tag_name: ${{ github.event.release.tag_name }}
        with:
          result-encoding: string
          retries: 3
          script: |
            github.rest.repos.getReleaseByTag({
              tag: process.env.tag_name,
              owner: context.repo.owner,
              repo: context.repo.repo
            })

      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x

      - name: Create NuGet Package
        run: dotnet pack -c Release /p:Version=${{ github.event.release.tag_name }} /p:PackageReleaseNotes="${{ steps.release-notes.outputs.result.body }}" /p:IncludeSymbols=true /p:SymbolPackageFormat=snupkg /p:ContinuousIntegrationBuild=true /p:EmbedUntrackedSources=true /p:PublishRepositoryUrl=true
        working-directory: ./src/Nlog.RabbitMQ.Target

      - name: Publish Nuget Package
        run: dotnet nuget push **/*.nupkg --api-key ${{ secrets.nuget_api_key }} --source https://api.nuget.org/v3/index.json
